pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
function _init()
    debug = false
    score = 0
    frm = 0     -- frame
    pl = {  show = true,
            x = 8*3,
            y = 0,
            sp = {1},
            speed = 10
    }
    
    coins = {}
    
    init_magic()
    init_coins()

    gravity = true
end

function _update()
    if pl.show then
        if btn(0) then move(-2, 0) end     
        if btn(1) then move( 2, 0) end

        if gravity then
            if btn(2) and check_map(0, 1, 0) then jmp = 4 end
            if btn(3) then move( 0, 2) end
            if frm % 1 == 0 then move(0, 4) end
        else
            if btn(2) then move(0, -2) end
            if btn(3) then move(0, 2) end
        end
    end
    
    if jmp > 0 then
        jmp -= 1
        move(0, -8)
    end

    -- check if player is on a coin
    for i=1, #coins do
        if coins[i].on then
            if pl.x == coins[i].x and pl.y == coins[i].y then
                coins[i].on = false
                score += coins[i].p
                sfx(0)
            end
        end
    end

    frm += 1
end

function _draw()
    cls()
    rectfill(cam.x-64,cam.y-64,cam.x+64,128,12)
    map()
    
    align_camera()
    
    rectfill(cam.x-64-16,cam.y+64-8*3,cam.x+64+16,cam.y+64,0)
    
    camera(cam.x-64, cam.y-64)
    
    for i=1, #coins do
        if coins[i].on then
            spr(get_spr_anim(coins[i]), coins[i].x, coins[i].y)
        else
            spr(4, coins[i].x, coins[i].y)
        end
    end
    if pl.show then p_draw() end
    
    if debug then
        printtext("x: "..pl.x  .. ", ~" .. gethitb(pl.x, pl.y).gx        , 1,129-8*3, 7)
        printtext("y: "..pl.y  .. ", ~" .. gethitb(pl.x, pl.y).gy        , 1,129-8*2, 7)

        printtext("coin x: "..coins[1].x..", y: "..coins[1].y, 1, 129-8, 7)
    end

    printtext("score: "..score, 1, 1, 7)
end
-->8
-- pico-8
function init_magic()
    cam = {x = pl.x, y = pl.y}
    jmp = 0 -- each num is 4px
end

function init_coins()
    cls()
    map()
    
    -- get all coins (sprite 6)
    for x=0,127 do
        for y=0,127 do
            if mget(x,y) == 6 then
                add(coins, {x = x*8, y = y*8, on=true,p=10,sp={6,7},speed=10})
            end
        end
    end
    cls()
end

function move(dx, dy)
    if abs(dx) > 0 then
        if not check_map(sgn(dx), 0, 0) then
            pl.x += dx
        else
            pl.x = gethitb(pl.x, pl.y).gx*8
        end
    end

    if abs(dy) > 0 then
        if not check_map(0, sgn(dy), 0) then
            pl.y += dy
        else
            pl.y = gethitb(pl.x, pl.y).gy*8
        end
    end
end

function gethitb(x,y) return {gx = flr((x+4)/8), gy = flr((y+4)/8)} end

function p_draw()
    spr(
        get_spr_anim(pl),
        pl.x, pl.y)

    local hb = gethitb(pl.x, pl.y)
    
    if debug then rect(hb.gx*8, hb.gy*8, hb.gx*8+7, hb.gy*8+7, 8) end
end

function check_map(dx,dy,fl)
    local hb = gethitb(pl.x,pl.y)
    return fget(mget(hb.gx+dx, hb.gy+dy), fl)
end

function align_camera()
    sz = 2
    local dz = {xmin = pl.x-8*sz, xmax = pl.x+8*sz,
                        ymin = pl.y-8*sz, ymax = pl.y+8*sz}
    
    if cam.x < dz.xmin then cam.x = dz.xmin end
    if cam.x > dz.xmax then cam.x = dz.xmax end
    if cam.y < dz.ymin then cam.y = dz.ymin end
    if cam.y > dz.ymax then cam.y = dz.ymax end
end

function printtext(txt,x,y,c)
    print(txt,cam.x+x-64,cam.y+y-64,c)
end

function get_spr_anim(obj)
    return obj.sp[((flr(frm/obj.speed))%#obj.sp)+1]
end

__gfx__
00000000000770000000000000000000cccccccc0000000077777777777777775555555555555555555555550000000000000000000000000000000000000000
00000000000770000000000000000000cccccccc0000000070000007700000075bbbbbb554444445566666650000000000000000000000000000000000000000
00700700888888880000000000000000cccccccc0000000070070007700070075bbbbbb554444445566666650000000000000000000000000000000000000000
00077000808888080000000000000000cccccccc0000000070770007700770075444444554444445566666650000000000000000000000000000000000000000
00077000801111080000000000000000cccccccc0000000070070007700070075444444554444445566666650000000000000000000000000000000000000000
00700700001111000000000000000000cccccccc0000000070777007700777075444444554444445566666650000000000000000000000000000000000000000
00000000001001000000000000000000cccccccc0000000070000007700000075444444554444445566666650000000000000000000000000000000000000000
00000000055005500000000000000000cccccccc0000000077777777777777775555555555555555555555550000000000000000000000000000000000000000
__gff__
0000000000000000010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000060000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0808080808080808080808080808080808080808080808080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0909090909090909090909090909090909090909090909090000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0909090909090909090909090909090909090909090909090000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000100001d2501d2501d2502425024250242501c2003420035200232003520027200352002a2002d2002e20033200322003320032200322003120000000000000000000000000000000000000000000000000000
